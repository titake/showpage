<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>运输公司/驾校</title>
	<link rel="icon" type="image/png" href="../images/icon_star2.png">
	<link rel="stylesheet" type="text/css" href="../styles/logupCss.css">
	<script type="text/javascript" src="../styles/myjs.js"></script>
	<script type="text/javascript" src="../lib/jquery-3.2.0.js"></script>
	<style type="text/css">
		/*内容*/
		.view_container{
			margin: 0px;
			width: 900px;
			display: flex;
			flex-direction: column;
			justify-content: flex-start;
			align-items: center;
		}
		/*子模块样式*/
		.view_BigDiv_info{
			display: flex;
			flex-direction: column;
			width: 820px;
			justify-content: flex-start;
			align-items: center;
			border: dashed;
			border-color: #a0a0a0;
			border-width: 0px 0px 1px 0px;
			padding-bottom: 50px;
			padding-top: 14px;
		}
		.text_DivName{
			width: 820px;
			font-size: 14.5px;
			font-family: 黑体;
			color: #585858;
			font-weight: 600;
			margin-bottom: 30px;
			text-align: center;			
		}
		/*子模块中每行div的样式*/
		.text_chexbox{
			width: 110px;
			height: 30px;
			margin: 0px;
			font-size: 14.5px;
			font-family: 宋体;
			color: #585858;
			font-weight: 600;
			display: inline;
			text-align: left;
		}
		.img_icon{
			width: 18px;
			height: 18px;
			padding: 0px;
			margin: 0px;
		}
		#id_compName_last{
			width: 120px;
			height: 37.33px;
			border: solid 1px #DBDBDB;
			border-left: dashed 1px #ccc;
			border-radius: 0px 4px 4px 0px;
			padding-left: 2px;
			background: rgba(255,255,255,0.9);
			font-size: 14.5px;
			font-family: 宋体;
			color: #585858;
			font-weight: 450;
		}
		.checkbox_css{
			font-family: 宋体;
			font-size: 14.5px;
			color: #585858;
			margin-left: 8px;
		}
		.text_textarea{
			width: 705px;
			height: 80px;
			padding: 10px;
			font-size: 14.5px;
			font-family: 宋体;
			color: #585858;
		}
		.btn_logup{
			width: 120px;
			height: 38px;
			background: #00B20B;
			border: none;
			border-radius: 4px;
			color: #fff;
			padding: 0px;
			text-align: center;
			font-size: 14.5px;
			margin-bottom: 50px;
		}
		option{
			font-size: 14.5px;
			font-family: 宋体;
			color: #585858;
			font-weight: 400;
		}

	</style>
</head>
<body>
	<div class="view_title">
		<div class="view_title_name">
			<img class="img_title" src="../images/login_back.jpg">
			<p class="text_title">汽车评星系统 | 注册</p>
		</div>
	</div>
	<div class="view_container">
		<ul class="view_tab">
			<li class="text_tab" style="margin-left:0px;">
				<h4>①步骤一</h4>
			</li>
			<li class="text_tab" style="color:#01CE3F;font-weight: 500;">
				<h4>②步骤二</h4>
			</li>
			<li class="text_tab">
				<h4>③步骤三</h4>
			</li>
		</ul>
		<div class="view_content_column">
			<!--企业基本信息模块-->
			<div class="view_BigDiv_info">
				<p class="text_DivName">企业基本信息</p>
				<div class="view_ItemDiv_info" style="margin-bottom: 5px;">
					<p class="text_inputName">企业名称</p>
					<input id="id_compName" type="text"  class="text_itemInput" style="width: 160px;margin-right: 0px;border-right: none; padding-left: 4px;border-radius: 4px 0px 0px 4px;" onblur="checkIfExist()">
					<select id="id_compName_last" onblur="checkIfExist()">
						<option value="有限责任公司">有限责任公司</option>
						<option value="股份有限公司">股份有限公司</option>
					</select>
					<div class="div_warn" id="id_div_star">
						<p class="text_inputName" style="width: 36px;margin-left: 50px;">星级</p>
						<img class="img_icon" id="id_star1" onmouseover="wantToselect('id_star1')" onmouseout="cancelWant('id_star1')" onclick="selectStar('id_star1')" src="../images/star_gray.png">
						<img class="img_icon" id="id_star2" onmouseover="wantToselect('id_star2')" onmouseout="cancelWant('id_star2')" onclick="selectStar('id_star2')" src="../images/star_gray.png">
						<img class="img_icon" id="id_star3" onmouseover="wantToselect('id_star3')" onmouseout="cancelWant('id_star3')" onclick="selectStar('id_star3')" src="../images/star_gray.png">
						<img class="img_icon" id="id_star4"  onmouseover="wantToselect('id_star4')" onmouseout="cancelWant('id_star4')" onclick="selectStar('id_star4')" src="../images/star_gray.png">
						<img class="img_icon" id="id_star5"  onmouseover="wantToselect('id_star5')" onmouseout="cancelWant('id_star5')" onclick="selectStar('id_star5')" src="../images/star_gray.png">
					</div>
					<p class="text_warn" id="id_warn_compName" style="display: none;">*</p>
				</div>
				<div class="div_warn" id="id_warn_exist" style="width: 705px;display: none;">
					<img src="../images/error.png" class="img_warn">
					<p class="text_warn">此企业已注册过！</p>
				</div>
				<div class="view_ItemDiv_info" style="margin-bottom: 28px; margin-top: 23px;">
					<p class="text_inputName">注册地址</p>
					<input id="id_registe_address" type="text"  class="text_itemInput" style="width: 635px;" onchange="change('registe_address')">
					<p class="text_warn" id="id_warn_location" style="display: none;">*</p>
				</div>
				<div class="view_ItemDiv_info">
					<p class="text_inputName">注册金额</p>
					<input placeholder="单位为万" id="id_registe_money" type="text" class="text_itemInput" style="width: 105px;" onchange="change('registe_money')">
					<p class="text_inputName" style="width: 14px;margin-right: 33px;">万</p>
					<p class="text_inputName">注册日期</p>
					<input type="date" id="id_registe_date" class="text_itemInput" style="width: 135px;margin-right: 34px;padding-left:10px;" onchange="change('registe_date')">                                              
					<p class="text_inputName">有效期至</p>
					<input type="date" id="id_registe_valid_date" class="text_itemInput" style="width: 135px;padding-left: 10px;" onchange="change('registe_valid_date')">
					<p class="text_warn" id="id_warn_date" style="display: none;">*</p>
				</div>
				<div class="view_ItemDiv_info" style="margin: 0px;">
					<p class="text_inputName" style="width: 92px;">主要经营范围</p>
					<p class="text_warn" id="id_warn_scope" style="display: none;">*</p>
				</div>
				<div class="view_ItemDiv_info">
					<p class="text_chexbox"><input id="id_person" type="checkbox" class="checkbox_css"> 客运</p>
					<p class="text_chexbox"><input id="id_good" type="checkbox" class="checkbox_css"> 货运</p>
					<p class="text_chexbox" ><input id="id_teach" type="checkbox" class="checkbox_css"> 驾校</p>
				</div>
				<div class="view_ItemDiv_info" style="margin-bottom: 0px;">
					<p class="text_inputName">有效资质</p>
					<p class="text_warn" id="id_warn_qualification" style="display: none;">*</p>
				</div>
				<div class="view_ItemDiv_info">
					<textarea class="text_textarea" id="id_qualification" onchange="change('qualification')"></textarea>
				</div>
			</div>
			<!--联系方式模块-->
			<div class="view_BigDiv_info" style="border: none;">
				<p class="text_DivName">企业联系方式</p>
				<div class="view_ItemDiv_info">
					<p class="text_inputName" style="width: 86px;margin-left: 45px">法人姓名</p>
					<input type="text" id="id_corporation" class="text_itemInput" style="width: 150px;margin-right: 49px;" onchange="change('corporation')">
					<p class="text_inputName">联系电话</p>
					<input type="text" id="id_corporation_phone" maxlength="11" class="text_itemInput" onchange="change('corporation_phone')">
					<p class="text_warn" id="id_warn_corporation" style="display: none;">*</p>
				</div>
				<div class="view_ItemDiv_info">
					<p class="text_inputName" style="width: 86px;margin-left: 45px;">主要负责人</p>
					<input type="text" id="id_charge_person" class="text_itemInput" style="width: 150px;margin-right: 49px;" onchange="change('charge_person')">
					<p class="text_inputName">联系电话</p>
					<input type="text" id="id_charge_phone" maxlength="11" class="text_itemInput" onchange="change('charge_phone')">
					<p class="text_warn" id="id_warn_charge" style="display: none;">*</p>
				</div>
			</div>

			<div class="view_ItemDiv_info" style="justify-content: space-around;">
				<button class="btn_logup" id="id_btn_goBefore" onmouseover="turnToBlur('id_btn_goBefore')" onmouseout="turnToClear('id_btn_goBefore')" onclick="window.location='logup_Step2_comp.html'">上一步</button>
				<button class="btn_logup" id="id_logupInfo_step2_submit" onmouseover="turnToBlur('id_logupInfo_step2_submit')" onmouseout="turnToClear('id_logupInfo_step2_submit')" onclick="addComp()">完成</button>
			</div>
		</div>
	</div>
	<div class="view_footer">
		<p class="text_footer">Copyright © 2016-2017 titake All Rights Reserved.</p>
	</div>
	<script type="text/javascript">
		exist = true;
		edit = false;
		if (window.location.search.search('&')<0) {
			name="";
			edit=false;
			userType =  decodeURI(window.location.search.split("?")[1].split("=")[1]);
			$(function(){
				$(".view_tab").css("display","flex");
			});
		}else{
			name = decodeURI(window.location.search.split("?")[1].split("=")[2]);
			userType =  decodeURI(window.location.search.split("?")[1].split("=")[1].split("&")[0]);
			edit=true;
			$(function(){
				$(".view_tab").css("display","none");
			});
		}
		if (userType=="super") {
			$(function(){
				$("#id_div_star").css("display","flex");
			});
		}else{
			$(function(){
				$("#id_div_star").hide();
			});
		}
		if (userType.search("super")>=0) {  //任何一种管理员
			$(function(){
				$(".view_tab").css("display","none");
				$(".view_title").hide();
				$("#id_btn_goBefore").hide();
			});
		}else{
			$(function(){
				$(".view_tab").css("display","flex");
				$(".view_title").css("display","flex");
				$("#id_btn_goBefore").css("display","flex");
			});
		}
		starSelected = 0;
		if (name!="") {
			var request = new XMLHttpRequest;
			request.open("GET","../ajax/getData_sql.php?flag=transComp_one_edit&compName="+name);
			request.send();
			request.onreadystatechange = function(){
				if (request.readyState===4) {
					if (request.status===200) {
						var result = JSON.parse(request.responseText);
						$(function(){
							var firstName = name.substr(0,name.length-6);
							var lastName = name.substr(name.length-6,6);
							$("#id_compName").val(firstName);
							var selector = "#id_compName_last>option[value='"+lastName+"']";
							$(selector).attr("selected",true);
							$("#id_registe_money").val(result.registe_money);
							$("#id_registe_address").val(result.registe_address);
							$("#id_registe_date").val(result.registe_date);
							$("#id_registe_valid_date").val(result.registe_valid_date);
							$("#id_corporation").val(result.corporation);
							$("#id_corporation_phone").val(result.corporation_phone);
							$("#id_charge_person").val(result.charge_person);
							$("#id_charge_phone").val(result.charge_phone);
							$("#id_qualification").val(result.qualification);
							$("#id_btn_goBefore").hide();
							var myscope = result.scope;
							if (myscope.search("person")>=0) {
								$("#id_person").attr("checked",true);
							}else if(myscope.search("good")>=0){
								$("#id_good").attr("checked",true);
							}else if (myscope.search("teach")>=0) {
								$("#id_teach").attr("checked",true);
							}
						});
						starSelected=result.star;
						var i=1;
						while(i<=starSelected){
							var id = 'id_star'+i;
							document.getElementById(id).src="../images/star_gold.png";
							i++;
						}
					}else{
						alert("error:"+request.status);
					}
				}
			}
		}
		function selectStar(starID){
			var i =parseInt(starID.substr(starID.length-1,1));
			starSelected = i;
			i++;
			while(i<=5){
				var id = "id_star"+i;
				document.getElementById(id).src = "../images/star_gray.png";
				i++;
			}
			i = starSelected;
			while(i>0){
				var id = "id_star"+i;
				document.getElementById(id).src = "../images/star_gold.png";
				i--;
			}
		}
		function wantToselect(starID){
			var i = parseInt(starID.substr(starID.length-1,1));
			var wantStar = i;
			i++;
			while(i<=5){
				var id = "id_star"+i;
				document.getElementById(id).src = "../images/star_gray.png";
				i++;
			}
			i = wantStar;
			while(i>0){
				var id = "id_star"+i;
				document.getElementById(id).src = "../images/star_gold.png";
				i--;
			}
		}
		function cancelWant(starID){
			var i = parseInt(starID.substr(starID.length-1,1));
			if (!starSelected) {
				while(i>0){
					var id = "id_star"+i;
					document.getElementById(id).src = "../images/star_gray.png";
					i--;
				}
			}else if (i!=starSelected) {
				while(i>starSelected){
					var id = "id_star"+i;
					document.getElementById(id).src = "../images/star_gray.png";
					i--;
				}
				i=starSelected;
				while(i>0){
					var id = "id_star"+i;
					document.getElementById(id).src = "../images/star_gold.png";
					i--;
				}
			}
		}
		function checkInfo() {
			var done = 0;
			if(!document.getElementById("id_person").checked && !document.getElementById("id_good").checked && !document.getElementById("id_teach").checked) {
				document.getElementById("id_warn_scope").style.display = "block";
			}else{
				document.getElementById("id_warn_scope").style.display = "none";
				done++;
			}
			if (document.getElementById("id_compName").value=="") {
				document.getElementById("id_warn_compName").style.display = "block";
			}else{
				done ++;
				document.getElementById("id_warn_compName").style.display = "none";
			}

			if(document.getElementById("id_registe_address").value==""){
				document.getElementById("id_warn_location").style.display = "block";
			}else{
				done ++;
				document.getElementById("id_warn_location").style.display = "none";
			}

			if (document.getElementById("id_registe_money").value==""||document.getElementById("id_registe_date").value==""||document.getElementById("id_registe_valid_date").value=="") {
				document.getElementById("id_warn_date").style.display = "block";
			}else{
				document.getElementById("id_warn_date").style.display = "none";
				done ++;
			}

			if (document.getElementById("id_qualification").value=="") {
				document.getElementById("id_warn_qualification").style.display = "block";
			}else{
				done ++;
				document.getElementById("id_warn_qualification").style.display = "none";
			} 

			if(document.getElementById("id_corporation").value==""||document.getElementById("id_corporation_phone").value=="") {
				document.getElementById("id_warn_corporation").style.display = "block";
			}else{
				done ++;
				document.getElementById("id_warn_corporation").style.display = "none";
			} 

			if(document.getElementById("id_charge_person").value==""||document.getElementById("id_charge_phone").value=="") {
				document.getElementById("id_warn_charge").style.display = "block";
			}else{
				done ++;
				document.getElementById("id_warn_charge").style.display = "none";
			}
			if (userType=="super") {
				if (!starSelected) {
					document.getElementById("id_warn_compName").style.display = "block";
				}else{
					done ++;
					document.getElementById("id_warn_compName").style.display = "none";
				}
				if (done===8) {
					return true;
				}else{
					return false;
				}
			}else{
				if (done===7) {
					return true;
				}else{
					return false;
				}
			}
		}
		function checkIfExist(){
			if (edit == false) {
				var compLastNames = document.getElementById("id_compName_last");
				var sindex = compLastNames.selectedIndex;
				var compName = document.getElementById("id_compName").value+compLastNames.options[sindex].value;
				var request = new XMLHttpRequest;
				request.open("GET","../ajax/ifExist.php?flag=FullcompName&compType=tb_transcomp&compName="+compName);
				request.send();
				request.onreadystatechange = function(){
					if (request.readyState===4) {
						if (request.status===200) {
							var result = JSON.parse(request.responseText);
							if (result.length==0) {
								exist = false;
								$(function(){
									$("#id_warn_exist").hide();
								});
							}else{
								exist = true;
								$(function(){
									$("#id_warn_exist").css("display","flex");
								});
							}
						}else{
							alert("error:"+request.status);
						}
					}
				}
			}
		}
		function getScope(){
			var scope = "";
			var scopeNum=0;
			if (document.getElementById("id_person").checked) {
				scope = "person";
				scopeNum++;
			}
			if (document.getElementById("id_good").checked) {
				if (scopeNum>0) {
					scope = scope+",good";
				}else{
					scope = "good";
				}
				scopeNum++
			}
			if (document.getElementById("id_teach").checked) {
				if (scopeNum>0) {
					scope=scope+",teach";
				}else{
					scope = "teach";
				}
			}
			return scope;
		}
		//编辑的都有哪些
		changes = "";
		function change(FLAG){
			if (edit==true) {
				if (changes.search(FLAG)<0) {
					changes = changes+","+FLAG;
				}
			}
		}
		function addComp(){
			if (edit==true) {
				changes = changes.substr(1,changes.length-1);
				var columns = changes.split(",");
				var sql = "update tb_transcomp set "
				if (changes.length>0) {
					for (var i = 0; i <columns.length; i++) {
					sql = sql+columns[i]+"='"+document.getElementById("id_"+columns[i]).value+"',"
					}
				}
				sql = sql+"scope='"+getScope()+"',star="+starSelected;
				var compLastNames = document.getElementById("id_compName_last");
				var sindex = compLastNames.selectedIndex;
				var compName = document.getElementById("id_compName").value+compLastNames.options[sindex].value;
				if (compName!=name) {
					sql = sql+",name='"+compName+"'";
				}
				sql = sql+" where name='"+name+"'";
				var request = new XMLHttpRequest;
				request.open("POST","../ajax/updateDB.php",true);
				request.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
				request.send("sql="+sql+"&flag=update");
				request.onreadystatechange = function(){
					if (request.readyState===4) {
						if (request.status===200) {
							var result = request.responseText;
							alert(result);
							if (result=="更新成功") {
								window.close();
							}
						}else{
							alert("error:"+request.status);
						}
					}
				}
			}else{
				var done = checkInfo();
				if (done && (!exist)) {
					var scope =getScope();
					var compLastNames = document.getElementById("id_compName_last");
					var sindex = compLastNames.selectedIndex;
					var compName = document.getElementById("id_compName").value+compLastNames.options[sindex].value;
					var request = new XMLHttpRequest;
					request.open("POST","../ajax/WriteDB.php",true);
					request.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
					request.send("flag=add_transComp&compName="+compName+
						"&registe_money="+parseFloat(document.getElementById("id_registe_money").value)+
						"&registe_address="+document.getElementById("id_registe_address").value+
						"&registe_date="+document.getElementById("id_registe_date").value+
						"&registe_valid_date="+document.getElementById("id_registe_valid_date").value+
						"&corporation="+document.getElementById("id_corporation").value+
						"&corporation_phone="+document.getElementById("id_corporation_phone").value+
						"&charge_person="+document.getElementById("id_charge_person").value+
						"&charge_phone="+document.getElementById("id_charge_phone").value+
						"&qualification="+document.getElementById("id_qualification").value+
						"&scope="+scope+
						"&star="+starSelected);
					request.onreadystatechange = function(){
						if (request.readyState===4) {
							if (request.status===200) {
								var result = JSON.parse(request.responseText);
								if (result.success) {
									if (userType.search("super")<0) {
										window.location.href ="logup_Step3_administer.html?compName="+document.getElementById("id_compName").value+"&usertype=transcomp";
									}else{
										alert("添加成功");
										window.close();
									}
								}else{
									alert("添加出错！错误原因："+result.reason);
								}
							}else{
								alert("error:"+request.status);
							}
						}
					}
				}
			}
		}
	</script>
</body>
</html>